NBM Format Specification
========================
# 1. このフォーマットについて
* このフォーマットの正式名称は「NBM Format」です。
    * NBM Formatを初めてサポートしたゲーム「NeoBM」によるものです。
    * 以下、本ドキュメントでは、「NBM」と略記
* このフォーマットは、2014年、suitougreenteaによって考案されました。
* このフォーマットは、BMSの拡張性の限界、実装による解釈の相違を解決するためのものです。
* このフォーマットに準拠しているファイルは、拡張子「.nbm」を使用することを推奨します。

# 2. NBMファイル
## 2.1. ファイル構造
* NBMに準拠したファイル(以下、NBMファイル)は、doctype宣言、ヘッダー部、リソース部、シーケンス部に分かれています。
    * 各部分はこの順番に現れなければいけません。
* NBMファイルの1行目はdoctype宣言である必要があります。
* NBMファイルのエンコードは**BOM付きの**UTF-8である必要があります。改行コードはCR+LFである必要があります。TODO
* 行頭、行末の空白文字は無視されます。
* `//`**で始まる行**はコメントとして解釈され、データ構造に影響を与えません。
    * `//`の前に空白文字があってもコメントとして解釈されます。
* ブロックとなる要素(子要素を持つ要素)は以下の5つです:


    .header
    .resource
    .sound
    .image
    .sequence


* ブロックとなる要素は`.end`によって閉じられます。
* パラメーターに使用される型は以下の5つです。
    * **String** : 文字列型です。`"`(ダブルクォート)によって囲まれます。
    * **Integer** : 整数型です。`0-9`の半角数字で表されますが、先頭に0を表記することは許容されません。
    * **Float** : 小数型です。内部的に浮動小数点で扱われます。`0-9`の半角数字及び`.`(ドット)で表されます。ドットは一度しか現れてはならなく、整数部分が2桁以上の場合に先頭に0を表記することや、整数部分を省略することは許容されません。
    * **Boolean** : 真偽型です。`true`または`false`のみが許容され、大文字小文字の違いは許容**されません**。
    * **配列** : `,`(コンマ)によって区切られる複数の値を持った型です。配列内の要素の型は上記の4つです。
* `:`(コロン)は、「大きな」区切り文字として使用されます。前後の空白文字は無視されます。
* `,`(コンマ)は、「小さな」区切り文字として使用されます。前後の空白文字は無視されます。

## 2.2. doctype宣言
* `.doctype:{documentType}`という形式で表されます。
* NBMファイルの1行目はdoctype宣言である必要があります。
* 引数は以下の通りです。
    * documentType (String) : NBMファイルの形式です。
        * 現在`"neobm"`のみ対応しています。

## 2.3. ヘッダー部
* `.header`により開始され、`.end`により終了されます。
* ヘッダー部は、キーと値のペアの集合で、行は`キー:値`と表されます。
* 定義されているキーは以下の通りです。(キー (値の型) : 説明 のように表記し、省略が不可能なものについてはキー名を太字で表示します。)
    * **title** (String) : 曲名
    * subtitle (String) : サブタイトル
    * artist (String) : アーティスト
    * subartist (String) : サブアーティスト
    * genre (String) : 曲のジャンル
    * basebpm (Float) : 曲のメインとなるテンポ(省略された場合は、シーケンスの頭のテンポを使用します)
    * maxbpm (Float) : テンポの最大値(シーケンスに定義されている最大テンポより優先度が高い)
    * minbpm (Float) : テンポの最小値(シーケンスに定義されている最小テンポより優先度が高い)
	* **resolution** (Integer) : シーケンスの解像度です。単位はtick/四分音符です。
* doctype `neobm` によって定義されるキーは以下の通りです。
    * judge (配列) : TODO
    * total (Float) : TOTAL値 (省略された場合はTODO)
    * chargenote (Boolean) : ロングノートの仕様を決定します。省略された場合は`false`です。
        * `true`の場合、ロングノートは先頭と末尾の両方判定されます。
        * `false`の場合、ロングノートは先頭のみ判定されます。

## 2.4. リソース部
* `.resource`により開始され、`.end`により終了されます。
* 子に2つのブロックとなる要素 `.sound`と`.image`を持つことが出来ます。同じものを重複することは出来ません。
* `.sound`と`.image`の子において、行は`{id}:{filename}`と表されます。
    * id (Integer) : 1以上の整数で、同じ種類のリソースにおいてIDを重複することは出来ません。
    * filename (String) : NBMファイルからの相対パスで、リソースの場所を表します。
* `.sound`においてサポートされる音声ファイルのフォーマットは以下の通りです: (TODO)

    
    .wav
    .ogg


* `.image`においてサポートされる画像/動画ファイルのフォーマットは以下の通りです: (TODO)


    .bmp
    .png
    .avi
    .mpg

## 2.5. シーケンス部
* `.sequence`により開始され、`.end`により終了されます。
* シーケンス部は、流れを持ったイベントのセットで、時間単位はtick(TODO:詳細)です。  
* 1行で1イベントを表します。1つのイベントは`:`により区切られ、`イベントの種類:引数:{step}` あるいは `イベントの種類:{step}` と表されます。
    * step (Integer) : 次のイベントとの間隔(単位はtick)
* イベントの種類は以下の通りです。 (イベントの種類 (引数) : 説明 のように表記します。)
    * n ({lane},{soundid}) : ノート
        * lane (Integer) : ノートのレーン(TODO 後述)を表します。
        * soundid (Integer) : リソース部で宣言された音声ファイルのIDで、鳴らすキー音を指定します。
    * l ({lane},{soundid},{gate}) : ロングノート
        * lane (Integer) : `n`と同様
        * soundid (Integer) : `n`と同様
        * gate (Integer) : ノートの長さ
    * lb ({lane},{soundid},{endsoundid},{gate}) : 終端にキー音があるロングノート
        * lane (Integer) : `n`と同様
        * soundid (Integer) : `n`と同様
        * endsoundid (Integer) : 終端のキー音
        * gate (Integer) : `l`と同様
    * n ({lane},{soundid}) : バックグラウンドで再生される音
        * lane (Integer) : エディタにおけるイベントの表示位置
        * soundid (Integer) : `n`と同様
    * time ({beat},{basetick}) : 拍子
        * beat (Integer) : 一小節の拍数
        * basetick (Integer) : 拍の単位となる音符の長さ(単位はtick)
    * tempo ({bpm}) : テンポ
        * bpm (Float) : テンポ(単位はbeat/minute)
* 他のどんなイベントが宣言される前に、`time`と`tempo`は宣言されている必要があります。